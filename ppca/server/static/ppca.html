<html>
<head>
<meta charset="UTF-8"/>
<script src="https://d3js.org/d3.v4.min.js"></script>
<title>PPCA</title>
<style>
svg{
background: #eee;
}
text{
fill: #fff;
font-size: 20px;
font-family: "Comic Sans MS", cursive, sans-serif
}

.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

</style>
</head>

<body>
<div><button id="reset" onclick="reset()">reset</button></div>

<svg id='interactivePlot' width=500 height=500></svg>
<svg id='feedbackPlot' width=500 height=500></svg>

<script>

function reset(){
    window.location = '/resetdata';
}


'use strict';
var iPlot = d3.select("#interactivePlot");
var fPlot = d3.select("#feedbackPlot");

function plot(data, svg){
    svg.selectAll('.point').remove();
    var sx = d3.scaleLinear()
                .domain([
                    d3.min(data, function(d){return Math.min(d.x, d.y)}),
                    d3.max(data, function(d){return Math.max(d.x, d.y)})
                ])
                .range([20,480]);
    var sy = d3.scaleLinear()
                .domain([
                    d3.min(data, function(d){return Math.min(d.x, d.y)}),
                    d3.max(data, function(d){return Math.max(d.x, d.y)})
                ])
                .range([480,20]);
    
    var drag = d3.drag()
    .on('start', function(d){
        d3.select(this).select('circle').attr('fill','red');   
    })
    .on('drag', function(d){
        d3.select(this).attr('transform', function(d){
            var x = sx(d.x) + d3.event.x;
            var y = sy(d.y) + d3.event.y;
            return 'translate('+x+','+y+')';
        });
    })
    .on('end', function(d){
        d.x = sx.invert( sx(d.x) + d3.event.x);
        d.y = sy.invert( sy(d.y) + d3.event.y);
        send(d);
        d3.select(this).select('circle').attr('fill','gray');   
    })

    var point = svg.selectAll('.point')
    .data(data).enter()
    .append('g')
    .attr('class', 'point')
    .attr('transform', function(d){ 
        return 'translate(' +sx(d.x)+','+sy(d.y)+')'
    })

    if (svg === iPlot)
        point.call(drag)


    point.append('circle')
    .attr('r', 20)
    .attr('fill', function(d,i){
        if (i<12){
            return 'blue';
        }else{
            return 'red';
        }
    })
    

    point.append('text')
    .attr('x', -7)
    .attr('y', 7)
    .text(function(d){return d.tag})
    .classed('noselect', true);
    

    //drag event
}

//init draw
d3.json('/data',
    function(data){
        plot(data, iPlot);
        plot(data, fPlot);
});


function send(d){
    //update draw
    d3.request('/data')
    .header("Content-Type", "application/json")
    .post(
        JSON.stringify(d),
        function(rawData){
            var data = JSON.parse(rawData.response);
            plot(data, fPlot);
        }
    );
}
</script>
</body>
</html>
